<div class="search-container">
  <input type="text" id="movie-search" autocomplete="off" placeholder="Search for movies..." />
  <ul id="suggestions" class="suggestions"></ul>
</div>

<style is:global>
  .search-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 2rem;
    position: relative;
    width: 100%;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  #movie-search {
    width: 100%;
    padding: 0.5rem 1rem;
    font-size: 1.2rem;
    border: 2px solid #4a4a4a;
    border-radius: 25px;
    background-color: #2c2c2c;
    color: white;
  }
  #movie-search:focus {
    outline: none;
    border-color: rgb(var(--accent-light));
  }
  .suggestions {
    position: absolute;
    top: calc(100% + 10px);
    left: 0;
    right: 0;
    background-color: #2c2c2c;
    border: 1px solid #4a4a4a;
    border-radius: 5px;
    list-style-type: none;
    margin: 0;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .suggestions > li {
    padding: 0.5rem;
    cursor: pointer;
    display: flex;
    max-height: 75px;
    align-items: center;
  }

  .suggestions > li:hover {
    background-color: #3a3a3a;
  }

  li > .suggestion-image {
    width: 60px;
    object-fit: cover;
    aspect-ratio: calc(1 / 1);
    margin-right: 10px;
    border-radius: 3px;
  }

  li > .suggestion-title {
    flex-grow: 1;
  }
</style>

<script>
  import { $ } from "@lib/dom";
  import { getMovies } from "@services/movies";
  import type { Movie } from "../types/movies";

  const searchInput = $<HTMLInputElement>("#movie-search");
  const suggestionsList = $<HTMLUListElement>("#suggestions");

  searchInput?.addEventListener("input", handleSearch);

  async function handleSearch() {
    if (searchInput === null || suggestionsList === null) return;
    const inputValue = searchInput.value.toLowerCase();

    if (inputValue.length < 3) {
      suggestionsList.style.display = "none";
      return;
    }

    const filteredMovies = await getMovies({ search: inputValue });
    displaySuggestions(filteredMovies);
  }

  function displaySuggestions(filteredMovies: Movie[]) {
    if (suggestionsList === null || searchInput === null) return;
    suggestionsList.innerHTML = "";

    if (filteredMovies.length === 0) return;

    filteredMovies.forEach((movie) => {
      const li = createSuggestion(movie);
      suggestionsList.appendChild(li);
    });
    suggestionsList.style.display = "block";
  }

  function createSuggestion(movie: Movie) {
    const li = document.createElement("li");
    li.innerHTML = `
          <img src="${movie.poster}" alt="${movie.title}" class="suggestion-image">
          <span class="suggestion-title">${movie.title}</span>
        `;
    li.addEventListener("click", () => {
      searchInput!.value = movie.title;
      suggestionsList!.style.display = "none";
    });
    return li;
  }

  // Hide suggestions when clicking outside
  document.addEventListener("click", (event) => {
    // @ts-expect-error
    if (!event.target.closest(".search-container") && suggestionsList) {
      suggestionsList.style.display = "none";
    }
  });
</script>
